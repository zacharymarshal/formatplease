// Generated by CoffeeScript 1.3.3
(function() {

  $(function() {
    var checkStatus, download_form, format_button, format_button_loading, format_button_message, number_of_status_checks, showDownloadLink, showLoadingMsg;
    download_form = $('#fp-paper-download_form');
    format_button = $('#fp-format_button');
    format_button_message = $('#fp-format_button-message');
    format_button_loading = $('#fp-format_button-loading');
    download_form.submit(function(e) {
      e.preventDefault();
      $('#fp-paper-download').html('');
      format_button.prop('disabled', true);
      format_button_loading.html('<i class="icon-spinner icon-spin"></i> ');
      return $.post(baseUrl(''), $(this).serialize(), function(result) {
        var paper_id, pid;
        pid = result.pid;
        paper_id = result.paper_id;
        return checkStatus(pid, paper_id);
      });
    });
    number_of_status_checks = 0;
    checkStatus = function(pid, paper_id) {
      number_of_status_checks++;
      showLoadingMsg(number_of_status_checks);
      return $.get(baseUrl("status/" + pid + "/" + paper_id), {}, function(result) {
        if (result.status === 'done') {
          return showDownloadLink(result.url);
        }
        if (result.status === 'error') {
          return alert('An error has occurred');
        }
        return setTimeout(function() {
          return checkStatus(pid, paper_id);
        }, 1000);
      });
    };
    showLoadingMsg = function(number_of_status_checks) {
      var message;
      message = (function() {
        switch (false) {
          case !(number_of_status_checks > 5):
            return 'Still Formatting...';
          case !(number_of_status_checks > 10):
            return 'Wow, still formatting, this is not normal...';
          case !(number_of_status_checks > 20):
            return 'Continuing to format ... either you have a really big paper or there are a lot of people using this right now';
          default:
            return 'Formatting...';
        }
      })();
      return format_button_message.html(message);
    };
    return showDownloadLink = function(download_url) {
      var link, link_input;
      link = $('<a />').attr({
        'href': download_url,
        'target': '_blank',
        'class': 'button red'
      }).html('<i class="icon-download"></i> Download');
      link_input = $('<input />').attr({
        'value': download_url,
        'class': 'fp-download_link_input'
      });
      format_button_loading.html('');
      format_button.removeClass('green');
      format_button_message.html('Format Again');
      format_button.prop('disabled', false);
      $('#fp-paper-download').html("" + (link.prop('outerHTML')) + "<br /><br /><i class=\"icon-link\"></i> " + (link_input.prop('outerHTML')) + "		");
      return $('.fp-download_link_input').select();
    };
  });

}).call(this);
